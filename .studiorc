#!/bin/bash
#
# This is the place you can extend the funcitonality of the studio

hab pkg install chef/studio-common >/dev/null
source "$(hab pkg path chef/studio-common)/bin/studio-common"

function build_cross_platform() {
  install_if_missing core/go go
  install_if_missing core/gox gox
  gox -output="bin/{{.Dir}}_{{.OS}}_{{.Arch}}" \
      -os="darwin linux windows" \
      -arch="amd64 386"
}

function update_deps() {
  install_if_missing core/go go
  go get -u github.com/chef/go-chef@master
}

# run unit tests
function unit_tests() {
  install_if_missing core/go go
  install_if_missing core/gcc gcc

  # Avoid running integration tests inside unit tests
  GO_PACKAGES=$(go list ./... | grep -v integration)
  go test $GO_PACKAGES -cover
}

# run integraiton tests
function integration_tests() {
  install_if_missing core/go go
  install_if_missing core/gcc gcc

  log_line "Building cross-platform binaries"
  build_cross_platform || return 1

  log_line "Running integration tests (github.com/chef/chef-analyze/integration)"
  PATH="/src/bin:$PATH" go test github.com/chef/chef-analyze/integration -v
}
